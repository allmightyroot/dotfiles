# ~/.zshrc

# Clone antidote if necessary.
[[ -e ${ZDOTDIR:-~}/.antidote ]] ||
  git clone https://github.com/mattmc3/antidote.git ${ZDOTDIR:-~}/.antidote

# Optimized compinit - only run once per day
autoload -Uz compinit
if [[ -n ${ZDOTDIR:-~}/.zcompdump(#qN.mh+24) ]]; then
  compinit
else
  compinit -C
fi

# Load all plugins from static file
source ~/.zsh_plugins.zsh

# Alias to regenerate static plugin file
alias antidote-update='source ${ZDOTDIR:-~}/.antidote/antidote.zsh && antidote bundle <${ZDOTDIR:-~}/.zsh_plugins.txt >${ZDOTDIR:-~}/.zsh_plugins.zsh && echo "Plugins regenerated! Restart your shell or run: source ~/.zshrc"'

# Lazy-load virtualenvwrapper - only loads when you actually use it
if [[ -f /usr/bin/virtualenvwrapper.sh ]]; then
  export WORKON_HOME=$HOME/.virtualenvs
  export PROJECT_HOME=$HOME/projects

  for cmd in workon mkvirtualenv rmvirtualenv deactivate lsvirtualenv; do
    eval "$cmd() {
      unset -f workon mkvirtualenv rmvirtualenv deactivate lsvirtualenv
      source /usr/bin/virtualenvwrapper.sh
      \$cmd \"\$@\"
    }"
  done
fi

# Conditional integrations
[[ "$TERM_PROGRAM" == "vscode" ]] && command -v code &>/dev/null && . "$(code --locate-shell-integration-path zsh)"
[[ -e "${HOME}/.iterm2_shell_integration.zsh" ]] && source "${HOME}/.iterm2_shell_integration.zsh"

# Optional: Run fastfetch only in interactive shells
[[ -o interactive ]] && command -v fastfetch &>/dev/null && fastfetch
